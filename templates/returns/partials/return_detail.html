{% load djicons i18n djicons djicons %}
<div data-back-url="{% url 'returns:return_list' %}" hidden></div>

<div class="p-4">
    <!-- Header Card -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="card-title">{{ return_obj.number }}</h2>
                    <p class="text-sm opacity-60">{{ return_obj.created_at|date:"d/m/Y H:i" }}</p>
                </div>
                <span class="badge badge-lg color-{% if return_obj.status == 'pending' %}warning{% elif return_obj.status == 'approved' %}primary{% elif return_obj.status == 'completed' %}success{% elif return_obj.status == 'rejected' %}error{% else %}medium{% endif %}" id="return-status-badge">
                    {{ return_obj.get_status_display }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <!-- Stats row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ return_obj.subtotal }}</div>
                    <div class="text-xs text-muted">{% trans "Subtotal" %}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ return_obj.tax_amount }}</div>
                    <div class="text-xs text-muted">{% trans "Tax" %}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-error">{{ return_obj.total_refund }}</div>
                    <div class="text-xs text-muted">{% trans "Total Refund" %}</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ return_obj.get_refund_method_display }}</div>
                    <div class="text-xs text-muted">{% trans "Method" %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Actions -->
    {% if return_obj.status == 'pending' or return_obj.status == 'approved' %}
    <div class="flex flex-wrap gap-2 mb-4" id="return-actions">
        {% if return_obj.status == 'pending' %}
        <a hx-get="{% url 'returns:return_edit' return_obj.id %}"
           hx-target="#main-content-area"
           hx-push-url="true"
           class="btn btn-outline flex-1">
            {% icon "create-outline" %} {% trans "Edit" %}
        </a>
        <button type="button" class="btn color-primary flex-1"
                onclick="returnAction('{% url 'returns:return_approve' return_obj.id %}', 'approve')">
            {% icon "checkmark-circle-outline" %} {% trans "Approve" %}
        </button>
        <button type="button" class="btn btn-outline color-error flex-1"
                onclick="returnAction('{% url 'returns:return_reject' return_obj.id %}', 'reject')">
            {% icon "close-circle-outline" %} {% trans "Reject" %}
        </button>
        {% endif %}

        {% if return_obj.status == 'approved' %}
        <button type="button" class="btn color-success flex-1"
                onclick="returnAction('{% url 'returns:return_complete' return_obj.id %}', 'complete')">
            {% icon "checkmark-done-outline" %} {% trans "Complete & Refund" %}
        </button>
        {% endif %}
    </div>
    {% endif %}

    <!-- Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">{% trans "Details" %}</h3>
        </div>
        <div class="list">
            {% if return_obj.customer %}
            <div class="list-item">
                <div class="list-item-start">{% icon "person-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.customer.name }}</div>
                    <div class="list-item-note">{% trans "Customer" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.original_sale %}
            <div class="list-item">
                <div class="list-item-start">{% icon "receipt-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.original_sale }}</div>
                    <div class="list-item-note">{% trans "Original Sale" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.reason %}
            <div class="list-item">
                <div class="list-item-start">{% icon "help-circle-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.reason.name }}</div>
                    <div class="list-item-note">{% trans "Return Reason" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.reason_notes %}
            <div class="list-item">
                <div class="list-item-start">{% icon "chatbox-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.reason_notes }}</div>
                    <div class="list-item-note">{% trans "Reason Notes" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.employee %}
            <div class="list-item">
                <div class="list-item-start">{% icon "people-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.employee.name }}</div>
                    <div class="list-item-note">{% trans "Processed By" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.approved_by %}
            <div class="list-item">
                <div class="list-item-start">{% icon "shield-checkmark-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.approved_by.name }} &middot; {{ return_obj.approved_at|date:"d/m/Y H:i" }}</div>
                    <div class="list-item-note">{% trans "Approved By" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.completed_at %}
            <div class="list-item">
                <div class="list-item-start">{% icon "checkmark-done-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.completed_at|date:"d/m/Y H:i" }}</div>
                    <div class="list-item-note">{% trans "Completed At" %}</div>
                </div>
            </div>
            {% endif %}
            {% if return_obj.notes %}
            <div class="list-item">
                <div class="list-item-start">{% icon "document-text-outline" css_class="text-muted" %}</div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ return_obj.notes }}</div>
                    <div class="list-item-note">{% trans "Notes" %}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Items -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <h3 class="card-title">{% trans "Items" %}</h3>
                <span class="badge">{{ items|length }}</span>
            </div>
        </div>
        {% if items %}
        <div class="list">
            {% for item in items %}
            <div class="list-item">
                <div class="list-item-start">
                    <span class="font-semibold">{{ item.quantity }}x</span>
                </div>
                <div class="list-item-content">
                    <div class="list-item-label">{{ item.product_name }}</div>
                    <div class="list-item-note">
                        {% if item.product_sku %}SKU: {{ item.product_sku }} &middot; {% endif %}
                        {% trans "Condition:" %} {{ item.get_condition_display }}
                        {% if item.restock %} &middot; {% icon "refresh-outline" css_class="text-xs" %} {% trans "Restock" %}{% endif %}
                        {% if item.notes %} &middot; <em>{{ item.notes }}</em>{% endif %}
                    </div>
                </div>
                <div class="list-item-end text-right">
                    <div class="font-semibold">{{ item.refund_amount }}</div>
                    <div class="text-xs text-muted">{{ item.unit_price }} x {{ item.quantity }}</div>
                    {% if return_obj.status == 'pending' %}
                    <button type="button" class="btn btn-ghost color-error btn-sm mt-1"
                            onclick="deleteItem('{% url 'returns:item_delete' return_obj.id item.id %}')">
                        {% icon "trash-outline" %}
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Totals -->
        <div class="list" style="border-top: 2px solid var(--color-base-300)">
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-label font-bold text-lg">{% trans "Total Refund" %}</div>
                </div>
                <div class="list-item-end font-bold text-lg text-error">{{ return_obj.total_refund }}</div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-8 text-muted">
            {% icon "cube-outline" css_class="text-4xl block mx-auto mb-2" %}
            <p>{% trans "No items added yet" %}</p>
        </div>
        {% endif %}
    </div>

    <!-- Danger Zone -->
    {% if return_obj.status == 'pending' %}
    <div class="card" style="border-color: var(--color-error)">
        <div class="card-header">
            <h3 class="card-title text-error">{% trans "Danger Zone" %}</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">{% trans "Permanently delete this return. This action cannot be undone." %}</p>
            <button type="button" class="btn btn-outline color-error"
                    onclick="deleteReturn()">
                {% icon "trash-outline" %} {% trans "Delete Return" %}
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
function returnAction(url, action) {
    if (action === 'reject' && !confirm('{% trans "Reject this return?" %}')) return;
    if (action === 'complete' && !confirm('{% trans "Complete this return and process the refund?" %}')) return;
    fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
    }).then(r => r.json()).then(data => {
        if (data.success) {
            htmx.ajax('GET', '{% url "returns:return_detail" return_obj.id %}', '#main-content-area');
        }
    });
}

function deleteItem(url) {
    if (confirm('{% trans "Remove this item from the return?" %}')) {
        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
        }).then(r => r.json()).then(data => {
            if (data.success) {
                htmx.ajax('GET', '{% url "returns:return_detail" return_obj.id %}', '#main-content-area');
            }
        });
    }
}

function deleteReturn() {
    if (confirm('{% trans "Delete this return permanently?" %}')) {
        fetch('{% url "returns:return_delete" return_obj.id %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
        }).then(r => r.json()).then(data => {
            if (data.success) {
                htmx.ajax('GET', '{% url "returns:return_list" %}', '#main-content-area');
            }
        });
    }
}
</script>
